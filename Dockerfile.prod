# ========================================
# 多阶段构建 - 生产环境 Dockerfile
# ========================================

# ---------- 构建阶段 ----------
FROM python:3.10-slim-bookworm AS builder

ENV PYTHONDONTWRITEBYTECODE=1
ENV PYTHONUNBUFFERED=1
ENV PIP_DISABLE_PIP_VERSION_CHECK=1
ENV PIP_INDEX_URL=https://repo.huaweicloud.com/repository/pypi/simple
ENV PIP_TRUSTED_HOST=repo.huaweicloud.com

WORKDIR /app

# 安装构建依赖
RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential \
    libpq-dev \
    libssl-dev \
    libffi-dev \
    libldap2-dev \
    libsasl2-dev \
    default-libmysqlclient-dev \
    libjpeg-dev \
    zlib1g-dev \
    libfreetype6-dev \
    libpng-dev \
    libcairo2-dev \
    libpango-1.0-0 \
    libpangocairo-1.0-0 \
    libgdk-pixbuf2.0-0 \
    && rm -rf /var/lib/apt/lists/*

# 安装 uv
RUN pip install uv

# 复制依赖文件并安装
COPY pyproject.toml uv.lock ./
RUN uv pip install --system -r pyproject.toml

# 复制应用代码
COPY . .

# 收集静态文件
RUN python manage.py collectstatic --noinput --clear


# ---------- 运行阶段 ----------
FROM python:3.10-slim-bookworm AS runner

ENV PYTHONDONTWRITEBYTECODE=1
ENV PYTHONUNBUFFERED=1
ENV TZ=Asia/Shanghai

# 只安装运行时依赖（无编译工具）
RUN apt-get update && apt-get install -y --no-install-recommends \
    libpq5 \
    libssl3 \
    libffi8 \
    libldap-2.4-2 \
    libsasl2-2 \
    libmagic1 \
    libmysqlclient21 \
    libjpeg62-turbo \
    zlib1g \
    libfreetype6 \
    libpng16-16 \
    libcairo2 \
    libpango-1.0-0 \
    libpangocairo-1.0-0 \
    libgdk-pixbuf-2.0-0 \
    shared-mime-info \
    tzdata \
    && rm -rf /var/lib/apt/lists/* \
    && ln -sf /usr/share/zoneinfo/$TZ /etc/localtime \
    && echo $TZ > /etc/timezone

# 创建非 root 用户
RUN useradd -m -s /bin/bash appuser

WORKDIR /app

# 从构建阶段复制虚拟环境（只复制必要部分）
COPY --from=builder --chown=appuser:appuser /app/.venv /home/appuser/.venv

# 复制应用代码（排除 .venv、测试等）
COPY --from=builder --chown=appuser:appuser \
    --exclude=/app/.venv \
    --exclude=/app/tests \
    --exclude=/app/htmlcov \
    --exclude=/app/.pytest_cache \
    /app /home/appuser/liang_ba

# 设置环境变量
ENV VIRTUAL_ENV=/home/appuser/.venv
ENV PATH="$VIRTUAL_ENV/bin:$PATH"
ENV DJANGO_SETTINGS_MODULE=production_settings

# 创建目录
RUN mkdir -p /home/appuser/liang_ba/logs /home/appuser/liang_ba/media /home/appuser/liang_ba/static
RUN chown -R appuser:appuser /home/appuser

USER appuser

# 健康检查
HEALTHCHECK --interval=30s --timeout=10s --start-period=40s --retries=3 \
    CMD python -c "import requests; requests.get('http://localhost:8000/health', timeout=5)" || exit 1

# 暴露端口
EXPOSE 8000

# 启动命令
CMD ["uwsgi", "--ini", "liangba.ini"]
