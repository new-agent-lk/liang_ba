# ========================================
# 多阶段构建 - 生产环境 Dockerfile
# ========================================

# ---------- 构建阶段 ----------
FROM ubuntu:20.04 AS builder

ARG USERNAME=ubuntu
ENV DEBIAN_FRONTEND=noninteractive
ENV TZ=Asia/Shanghai

# 国内源加速
RUN sed -i "s@http://.*archive.ubuntu.com@http://mirrors.huaweicloud.com@g" /etc/apt/sources.list && \
    sed -i "s@http://.*security.ubuntu.com@http://mirrors.huaweicloud.com@g" /etc/apt/sources.list

# 安装构建依赖
RUN apt-get update && apt-get install -y \
    python3 \
    python3-venv \
    python3-pip \
    python3-dev \
    gcc \
    pkg-config \
    libpq-dev \
    libssl-dev \
    libffi-dev \
    libldap2-dev \
    libsasl2-dev \
    libmysqlclient-dev \
    libjpeg-dev \
    zlib1g-dev \
    libfreetype6-dev \
    libpng-dev \
    libcairo2-dev \
    libpango-1.0-0 \
    libpangocairo-1.0-0 \
    libgdk-pixbuf2.0-0 \
    curl \
 && apt-get clean \
 && rm -rf /var/lib/apt/lists/*

# 创建用户
RUN useradd -m -s /bin/bash ${USERNAME}

# pip 国内源
RUN mkdir -p /home/${USERNAME}/.pip \
 && echo "[global]" > /home/${USERNAME}/.pip/pip.conf \
 && echo "index-url = https://repo.huaweicloud.com/repository/pypi/simple" >> /home/${USERNAME}/.pip/pip.conf \
 && echo "trusted-host = repo.huaweicloud.com" >> /home/${USERNAME}/.pip/pip.conf

USER ${USERNAME}
WORKDIR /home/${USERNAME}/liang_ba

# 安装 uv
RUN pip3 install --user uv

# 复制依赖文件
COPY --chown=${USERNAME}:${USERNAME} pyproject.toml uv.lock ./

# 创建虚拟环境并安装依赖
ENV VIRTUAL_ENV=/home/${USERNAME}/liang_ba/.venv
ENV PATH="/home/${USERNAME}/.local/bin:$VIRTUAL_ENV/bin:$PATH"

RUN python3 -m venv $VIRTUAL_ENV \
 && uv pip install --no-cache -r pyproject.toml

# 复制应用代码
COPY --chown=${USERNAME}:${USERNAME} . .

# 收集静态文件（如果需要）
# RUN python manage.py collectstatic --noinput


# ---------- 运行阶段 ----------
FROM ubuntu:20.04

ARG USERNAME=ubuntu
ENV DEBIAN_FRONTEND=noninteractive
ENV TZ=Asia/Shanghai

# 国内源
RUN sed -i "s@http://.*archive.ubuntu.com@http://mirrors.huaweicloud.com@g" /etc/apt/sources.list && \
    sed -i "s@http://.*security.ubuntu.com@http://mirrors.huaweicloud.com@g" /etc/apt/sources.list

# 仅安装运行时依赖
RUN apt-get update && apt-get install -y \
    python3 \
    python3-venv \
    libpq5 \
    libssl1.1 \
    libffi7 \
    libldap-2.4-2 \
    libsasl2-2 \
    libmagic1 \
    libmysqlclient21 \
    libjpeg8 \
    zlib1g \
    libfreetype6 \
    libpng16-16 \
    libcairo2 \
    libpango-1.0-0 \
    libpangocairo-1.0-0 \
    libgdk-pixbuf2.0-0 \
    shared-mime-info \
    locales \
    tzdata \
 && apt-get clean \
 && rm -rf /var/lib/apt/lists/*

# Locale 配置
RUN locale-gen en_US.UTF-8 \
 && ln -sf /usr/share/zoneinfo/$TZ /etc/localtime \
 && echo $TZ > /etc/timezone \
 && dpkg-reconfigure -f noninteractive tzdata

ENV LANG=en_US.UTF-8
ENV LC_ALL=en_US.UTF-8
ENV PYTHONIOENCODING=utf-8

# 创建用户
RUN useradd -m -s /bin/bash ${USERNAME}

USER ${USERNAME}
WORKDIR /home/${USERNAME}/liang_ba

# 从构建阶段复制虚拟环境和应用代码
COPY --from=builder --chown=${USERNAME}:${USERNAME} /home/${USERNAME}/liang_ba /home/${USERNAME}/liang_ba

# 环境变量
ENV VIRTUAL_ENV=/home/${USERNAME}/liang_ba/.venv
ENV PATH="$VIRTUAL_ENV/bin:$PATH"
ENV PYTHONUNBUFFERED=1
ENV DJANGO_SETTINGS_MODULE=local_settings

# 创建必要的目录
RUN mkdir -p logs media static

# 健康检查
HEALTHCHECK --interval=30s --timeout=10s --start-period=40s --retries=3 \
  CMD python -c "import requests; requests.get('http://localhost:8000/admin/', timeout=5)" || exit 1

# 暴露端口
EXPOSE 8000

# 启动命令（使用 uWSGI）
CMD ["uwsgi", "--ini", "liangba.ini"]
